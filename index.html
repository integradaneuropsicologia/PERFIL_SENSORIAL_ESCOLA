<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Perfil Sensorial Escolar</title>
<style>
  :root{
    --bg:#0e1625; --card:#14213b; --line:#2b3f66;
    --text:#f8fafc; --muted:#cbd5e1;
    --pri:#6d28d9; --ok:#10b981; --err:#ef4444; --warn:#f59e0b;
    --chip:#0b1220; --chipHover:#0f1a2e; --chipSel:#1e293b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .wrap{max-width:1024px;margin:20px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:18px}
  h1{margin:0 0 6px;font-size:1.45rem}
  .muted{color:var(--muted)}

  .grid-info{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:12px 0 6px}
  @media (max-width:720px){.grid-info{grid-template-columns:1fr}}
  .info{background:rgba(0,0,0,.18);border:1px solid var(--line);border-radius:12px;padding:12px}
  .info b{display:block;margin-bottom:4px;color:#e2e8f0}

  .section{
    margin:18px 0 8px;
    padding:10px 12px;
    border:1px solid var(--line);
    border-radius:12px;
    background:rgba(0,0,0,.18);
    font-weight:700
  }

  /* ===== ITENS ===== */
  .item{
    border:1px solid var(--line);
    border-radius:12px;
    padding:12px;
    background:rgba(0,0,0,.18);
    margin-bottom:12px
  }
  .stem{font-size:1rem;margin-bottom:10px}
  .scale{
    display:grid;
    grid-template-columns:repeat(5,minmax(160px,1fr));
    gap:10px
  }
  @media (max-width:680px){
    .scale{grid-template-columns:1fr}
  }

  /* Botões (1..5) */
  .opt{
    display:flex;align-items:center;gap:10px;
    padding:10px 12px;
    border:1px solid var(--line);
    border-radius:12px;
    background:var(--chip);
    cursor:pointer;
    transition:background .15s ease, border-color .15s ease, transform .05s ease;
  }
  .opt:hover{
    background:var(--chipHover);
    border-color:#4f70ff;
    transform:translateY(-1px)
  }
  .opt input{
    appearance:none;-webkit-appearance:none;
    width:0;height:0;position:absolute;opacity:0
  }
  .opt span{font-weight:600}
  .opt small{opacity:.8}
  .opt:has(input:checked){
    background:var(--chipSel);
    border-color:#6d28d9;
    box-shadow:0 0 0 1px #6d28d9 inset
  }

  .legend{
    display:flex;flex-wrap:wrap;gap:8px;margin:6px 0 12px
  }
  .pill{
    display:inline-block;
    padding:4px 8px;
    border-radius:999px;
    border:1px solid var(--line);
    background:rgba(0,0,0,.25);
    font-size:.86rem
  }

  /* Ações */
  .btn{
    display:inline-flex;align-items:center;gap:10px;
    background:var(--pri);border:none;color:#fff;
    padding:12px 16px;border-radius:12px;
    cursor:pointer;font-weight:600
  }
  .btn.ok{background:var(--ok)}
  .btn.ghost{
    background:transparent;
    border:1px solid var(--line);
    color:var(--muted)
  }
  .btn:disabled{opacity:.6;cursor:not-allowed}

  /* Mensagens */
  .msg{margin:12px 0;padding:12px;border-radius:10px}
  .okbox{background:#06351f;border:1px solid #0e6c45;color:#c8ffe3}
  .errbox{background:#3b0d0d;border:1px solid #7f1d1d;color:#ffd5d5}
  .warnbox{background:#3a2903;border:1px solid #885e09;color:#ffe6b0}

  /* Progresso */
  .progress{
    height:10px;
    background:rgba(255,255,255,.05);
    border:1px solid var(--line);
    border-radius:999px;
    overflow:hidden
  }
  .bar{
    height:100%;
    width:0%;
    background:linear-gradient(90deg, #6d28d9, #10b981)
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Perfil Sensorial Escolar</h1>
    <p class="muted">
      Responda conforme ocorre com você. A escala é:
      <b>Quase nunca</b>, <b>Raramente</b>, <b>Ocasionalmente</b>, <b>Frequentemente</b>, <b>Quase sempre</b>.
    </p>

    <div class="legend">
      <span class="pill">1 = Quase nunca</span>
      <span class="pill">2 = Raramente</span>
      <span class="pill">3 = Ocasionalmente</span>
      <span class="pill">4 = Frequentemente</span>
      <span class="pill">5 = Quase sempre</span>
    </div>

    <div id="pacInfo" class="grid-info" style="display:none;"></div>

    <div id="progressWrap" style="display:none; gap:8px; align-items:center; margin:8px 0 0;">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:6px">
        <span class="muted" id="progressText">Progresso: 0/0</span>
        <button id="clearDraft" class="btn ghost" type="button" title="Limpar rascunho local">Limpar rascunho</button>
      </div>
      <div class="progress"><div class="bar" id="bar"></div></div>
    </div>

    <form id="form" style="margin-top:14px; display:none;" novalidate>
      <div id="qs"></div>
      <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
        <button id="btnSubmit" class="btn ok" type="submit">Enviar respostas</button>
        <button id="btnSave" class="btn ghost" type="button" title="Salvar rascunho">Salvar rascunho</button>
      </div>
      <div id="msg" class="msg" style="display:none" role="alert" aria-live="polite"></div>
    </form>

    <div id="alert" class="msg" style="display:none" role="alert" aria-live="assertive"></div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const SHEETDB_BASE = "https://sheetdb.io/api/v1/8pmdh33s9fvy8";
const SHEETS = {
  PATIENTS:"Patients",
  TOKENS:"LinkTokens",
  SCORES:"Scores_PERFIL_SENSORIAL_ESCOLA"
};
const CODE = "PERFIL_SENSORIAL_ESCOLA";
const PORTAL_URL = "https://integradaneuropsicologia.github.io/formularios/";
const RELEASE_KEYS = ["PERFIL_SENSORIAL_ESCOLA"]; // precisa estar "sim" no Patients

/* ===== HELPERS ===== */
const $ = s => document.querySelector(s);
const onlyDigits = s => (s||"").replace(/\D+/g,"");
const qs = k => new URLSearchParams(location.search).get(k) || "";
const TOKEN = qs("token");

function setBox(id, text, kind="ok"){
  const el=$(id); if(!el) return;
  el.textContent = text;
  el.className = "msg " + (kind==="ok"?"okbox":kind==="warn"?"warnbox":"errbox");
  el.style.display = "block";
}
function hideBox(id){
  const el=$(id);
  if(el){ el.style.display="none"; el.textContent=""; }
}
function maskCPF(cpf){
  const d = onlyDigits(cpf||"");
  if(d.length!==11) return cpf||"";
  return `${d.slice(0,3)}.${d.slice(3,6)}.${d.slice(6,9)}-${d.slice(9)}`;
}
function fmtDateISO(iso){
  if(!iso) return "";
  const [y,m,d] = String(iso).split("-");
  if(!y||!m||!d) return iso;
  return `${d}/${m}/${y}`;
}
async function GET(url){
  const r=await fetch(url);
  if(!r.ok) throw new Error("HTTP "+r.status);
  return r.json();
}
async function sheetSearch(sheet, params){
  const usp = new URLSearchParams(params);
  return GET(`${SHEETDB_BASE}/search?sheet=${encodeURIComponent(sheet)}&${usp.toString()}`);
}
async function sheetCreate(sheet, row){
  const r = await fetch(`${SHEETDB_BASE}?sheet=${encodeURIComponent(sheet)}`, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ data:[row] })
  });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
async function sheetPatchBy(sheet, column, value, data){
  const r = await fetch(
    `${SHEETDB_BASE}/${encodeURIComponent(column)}/${encodeURIComponent(value)}?sheet=${encodeURIComponent(sheet)}`,
    {
      method:"PATCH",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ data })
    }
  );
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
function goPortalWithToken(){
  try{
    const u = new URL(PORTAL_URL, location.href);
    if (TOKEN) u.searchParams.set("token", TOKEN);
    location.href = u.toString();
  }catch(_){
    const sep = PORTAL_URL.includes("?") ? "&" : "?";
    location.href = PORTAL_URL + (TOKEN ? sep + "token=" + encodeURIComponent(TOKEN) : "");
  }
}

/* ===== ITENS ===== */
/* Observação: são 44 itens reais, apesar do comentário “60” no rascunho original */
const ITEMS = [
  // A — Processamento auditivo
  {sec:'A — Processamento auditivo', text:'1. Perde instruções verbais na sala de aula mais do que estudantes da mesma idade.'},
  {text:'2. Para de prestar atenção no professor e parece ignorá-lo.'},
  {text:'3. Tem dificuldade de concluir tarefas em uma condição barulhenta.'},
  {text:'4. Manda os outros ficarem quietos.'},
  {text:'5. Fica angustiado(a) durante reuniões, almoços ou outros grandes encontros.'},
  {text:'6. Reage intensamente a sons inesperados ou barulhentos (por exemplo, alarmes de incêndio, livros caindo, portas batendo, anúncios, sinos, etc.).'},
  {text:'7. Tem dificuldades de participar de atividades em grupo nas quais há muito falatório.'},

  // B — Processamento visual
  {sec:'B — Processamento visual', text:'8. Perde instruções escritas ou demonstradas mais do que estudantes da mesma idade.'},
  {text:'9. Tem dificuldade para manter materiais e acessórios organizados para uso durante o dia.'},
  {text:'10. Deixa itens em branco em uma folha de tarefas com muitas informações escritas, apesar de saber as respostas.'},
  {text:'11. Observa as pessoas conforme elas se movem ao redor da sala.'},
  {text:'12. Se desvia de tarefas para observar todas as ações da sala.'},
  {text:'13. Não faz contato visual com os professores durante as interações no dia a dia.'},
  {text:'14. É atraído(a) por telas de TV ou de computador com gráficos intensamente coloridos, em ritmo acelerado.'},

  // C — Processamento do tato
  {sec:'C — Processamento do tato', text:'15. Fica demasiadamente perto de outras pessoas ao conversar face a face.'},
  {text:'16. Não parece perceber quando seu rosto e mãos continuam sujos.'},
  {text:'17. Toca as pessoas ou objetos a ponto de incomodar outros.'},
  {text:'18. Exibe a necessidade de tocar objetos, superfícies ou texturas (por exemplo, quer obter a sensação de tudo ao redor).'},
  {text:'19. Deseja limpar as mãos rapidamente durante tarefas que envolvem sujeira.'},
  {text:'20. Se incomoda facilmente com lesões pequenas (por exemplo, ao esbarrar em alguma coisa, se arranha ou se corta).'},
  {text:'21. Usa apenas as pontas dos dedos para trabalhar em projetos que exigem manipulação.'},
  {text:'22. Se esquiva ou recua quando seu corpo é tocado ou quando outras pessoas chegam muito perto.'},

  // D — Processamento de movimentos
  {sec:'D — Processamento de movimentos', text:'23. Não consegue manter objetos estáveis ao realizar tarefas (por exemplo, não segura o papel enquanto escreve).'},
  {text:'24. Brinca com ou manuseia objetos (por exemplo, lápis, cadernos, pastas).'},
  {text:'25. É inquieto(a) ou sente-se perturbado(a) ao ficar em pé em uma fila ou próximo(a) a outras pessoas (por exemplo, entrar no ônibus, entrar na escola, sentar-se de forma organizada).'},
  {text:'26. Relaxa o corpo, afunda-se ou estende-se na cadeira.'},
  {text:'27. Esbarra em coisas, sem conseguir notar objetos ou pessoas no caminho.'},
  {text:'28. Está sempre ativo(a).'},
  {text:'29. Parece encontrar infinitas razões para se aproximar de um professor.'},
  {text:'30. É mais lento(a) para participar de tarefas ou atividades fisicamente ativas do que estudantes da mesma idade.'},
  {text:'31. Fica em pé ou senta-se ao lado do parquinho durante o intervalo.'},
  {text:'32. Se recusa a participar de jogos de equipe (por exemplo, futebol, basquete).'},

  // E — Respostas comportamentais
  {sec:'E — Respostas comportamentais', text:'33. Faz as coisas de uma maneira mais difícil do que necessário (por exemplo, perde tempo, move-se lentamente).'},
  {text:'34. Parece estar cansado(a) (por exemplo, não tem energia, é lento(a)).'},
  {text:'35. Pode ser descrito(a) como reativo em excesso ou dramático em comparação a estudantes da mesma idade.'},
  {text:'36. Não tem senso de humor.'},
  {text:'37. Pode ser descrito(a) como inflexível em comparação a estudantes da mesma idade.'},
  {text:'38. Fica angustiado(a) com mudanças nos planos, rotinas ou expectativas.'},
  {text:'39. Pode ser teimoso(a) ou não cooperativo(a).'},
  {text:'40. Persevera até um ponto que interfere com a participação (por exemplo, não consegue mudar de atividade).'},
  {text:'41. Se afasta quando ocorrem mudanças no ambiente ou na rotina.'},
  {text:'42. Fica frustrado(a) facilmente.'},
  {text:'43. Interage ou participa em grupos com menos frequência que estudantes da mesma idade.'},
  {text:'44. Se incomoda quando as regras são quebradas.'}
];

const TOTAL_ITEMS = ITEMS.length;

/* opções de resposta globais para reuso */
const RESPONSE_CHOICES = [
  {v:1, l:'Quase nunca'},
  {v:2, l:'Raramente'},
  {v:3, l:'Ocasionalmente'},
  {v:4, l:'Frequentemente'},
  {v:5, l:'Quase sempre'}
];

/* ===== RENDER ===== */
function renderQuestions(){
  const host = $("#qs"); host.innerHTML = "";

  ITEMS.forEach((it, idx)=>{
    if (it.sec){
      const s = document.createElement('div');
      s.className = 'section';
      s.textContent = it.sec;
      host.appendChild(s);
    }

    const q = idx+1;
    const qn = String(q).padStart(2,"0");

    const row = document.createElement('div');
    row.className = 'item';
    row.setAttribute('data-q', String(q));

    const stem = document.createElement('div');
    stem.className = 'stem';
    stem.id = `s${qn}`;
    stem.textContent = `${q}. ${it.text}`;

    const scale = document.createElement('div');
    scale.className = 'scale';

    RESPONSE_CHOICES.forEach(c=>{
      const lab = document.createElement('label');
      lab.className = 'opt';
      lab.setAttribute('title', `${c.l} (${c.v})`);
      const id = `q${qn}_${c.v}`;
      lab.innerHTML = `
        <input type="radio" name="q${qn}" id="${id}" value="${c.value ?? c.v}" required aria-labelledby="s${qn}">
        <span>${c.l}</span><small></small>`;
      scale.appendChild(lab);
    });

    row.append(stem, scale);
    host.appendChild(row);
  });

  // inicializa texto de progresso
  $("#progressText").textContent = `Progresso: 0/${TOTAL_ITEMS}`;
}

/* ===== ESTADO ===== */
let patient=null, tokenRow=null, CPF="";
const STORAGE_KEY = `ASP60_${TOKEN||'anon'}`;
let startAt = Date.now();

/* ===== BOOT ===== */
(async function boot(){
  try{
    if(!TOKEN){
      setBox("#alert","Link inválido (sem token). Solicite um novo link.","err");
      return;
    }

    // valida token
    const trows = await sheetSearch(SHEETS.TOKENS, { token: TOKEN });
    if(!trows || !trows.length) throw new Error("Token inválido ou expirado.");
    tokenRow = trows[0];
    if(String(tokenRow.disabled||"não").toLowerCase()==="sim")
      throw new Error("Token desativado. Peça um novo link.");
    if(tokenRow.expires_at && new Date(tokenRow.expires_at) < new Date())
      throw new Error("Token expirado. Peça um novo link.");

    // paciente
    CPF = onlyDigits(tokenRow.cpf||"");
    if(!CPF) throw new Error("Token sem CPF vinculado.");
    const prows = await sheetSearch(SHEETS.PATIENTS, { cpf: CPF });
    if(!prows || !prows.length) throw new Error("Paciente não encontrado.");
    patient = prows[0];

    // liberação
    const isAllowed = RELEASE_KEYS.some(
      k => String(patient[k]||"").trim().toLowerCase()==="sim"
    );
    if(!isAllowed){
      setBox("#alert","Este formulário não está liberado para você.","err");
      return;
    }

    // já respondeu?
    const doneKeys = RELEASE_KEYS.map(k => `${k}_FEITO`);
    const anyDoneFlag = doneKeys.some(
      k => String(patient[k]||"").trim().toLowerCase()==="sim"
    );
    const already = await sheetSearch(SHEETS.SCORES, { cpf: CPF, code: CODE });
    if(anyDoneFlag || (already && already.length)){
      setBox("#alert","Você já respondeu este formulário. Voltando ao portal…","ok");
      setTimeout(goPortalWithToken, 1200);
      return;
    }

    // Render UI
    renderPatientInfo();
    renderQuestions();
    restoreDraft();
    updateProgress();

    $("#pacInfo").style.display = "grid";
    $("#form").style.display = "block";
    $("#progressWrap").style.display = "block";
    hideBox("#alert");

    startAt = Date.now();

  }catch(err){
    console.error(err);
    setBox("#alert", err.message || "Falha ao abrir o formulário. Tente novamente mais tarde.", "err");
  }
})();

function renderPatientInfo(){
  const g = $("#pacInfo"); g.innerHTML="";
  const info = [
    ["Nome", patient.nome || "-"],
    ["WhatsApp", patient.whatsapp || "-"]
  ];
  for(const [k,v] of info){
    const div = document.createElement("div");
    div.className = "info";
    div.innerHTML = `<b>${k}</b><div>${v||"-"}</div>`;
    g.appendChild(div);
  }
}

/* ===== RASCUNHO LOCAL ===== */
function saveDraft(){
  const data = {};
  for(let i=1;i<=TOTAL_ITEMS;i++){
    const qn = String(i).padStart(2,"0");
    const sel = document.querySelector(`input[name="q${qn}"]:checked`);
    if(sel) data[`q${qn}`] = Number(sel.value);
  }
  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }catch(e){
    console.warn("Sem espaço para salvar rascunho");
  }
}
function restoreDraft(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    const data = JSON.parse(raw);
    for(const [k,v] of Object.entries(data||{})){
      const el = document.querySelector(`input[name="${k}"][value="${v}"]`);
      if(el){ el.checked = true; }
    }
  }catch(e){
    /* ignore */
  }
}
function clearDraft(){
  try{ localStorage.removeItem(STORAGE_KEY); }catch(e){}
}

function countAnswered(){
  let c=0;
  for(let i=1;i<=TOTAL_ITEMS;i++){
    const qn=String(i).padStart(2,'0');
    if(document.querySelector(`input[name="q${qn}"]:checked`)) c++;
  }
  return c;
}
function updateProgress(){
  const answered = countAnswered();
  $("#progressText").textContent = `Progresso: ${answered}/${TOTAL_ITEMS}`;
  $("#bar").style.width = `${(answered/TOTAL_ITEMS)*100}%`;
}

/* ===== EVENTOS DE UI ===== */
addEventListener('change', (e)=>{
  if(e.target && e.target.matches('input[type="radio"][name^="q"]')){
    saveDraft();
    updateProgress();
  }
});
$("#btnSave").addEventListener('click', ()=>{
  saveDraft();
  setBox('#msg','Rascunho salvo neste dispositivo.','ok');
});
$("#clearDraft").addEventListener('click', ()=>{
  clearDraft();
  setBox('#msg','Rascunho apagado.','warn');
});

/* ===== DOMÍNIOS / FATORES ===== */
const auditivo = [1,2,3,4,5,6,7];
const visual = [8,9,10,11,12,13,14];
const tatil = [15,16,17,18,19,20,21,22];
const movimento = [23,24,25,26,27,28,29,30];
const comportamental = [33,34,35,36,37,38,39,40,41,42,43];

const exploracao = [11,14,15,17,18,24,28,29];
const esquiva = [22,30,31,32,36,37,38,40,41,42,43];
const sensibilidade = [4,6,7,12,19,20,21,25,35,39,44];
const observacao = [1,2,3,8,9,10,13,16,23,26,27,33,34];

const fatorEscolar1 = [1,2,8,9,10,15,16,17,24,25,26,27,28];
const fatorEscolar2 = [4,11,12,14,18,19,20,29,35,44];
const fatorEscolar3 = [3,5,7,21,22,33,38,39,40,41,42];
const fatorEscolar4 = [13,23,30,31,32,34,36,37,43];

/* utilitário pra somar subconjuntos usando um mapa de respostas */
function sumSubset(indices, map){
  let s=0;
  for(const i of indices){
    const key = "q"+String(i).padStart(2,"0");
    s += map[key] ?? 0;
  }
  return s;
}

/* calcula todos os scores e total bruto */
function computeScores(map){
  const scores = {
    exploracao:          sumSubset(exploracao, map),
    esquiva:             sumSubset(esquiva, map),
    sensibilidade:       sumSubset(sensibilidade, map),
    observacao:          sumSubset(observacao, map),

    proc_auditivo:       sumSubset(auditivo, map),
    proc_visual:         sumSubset(visual, map),
    proc_tatil:          sumSubset(tatil, map),
    proc_movimento:      sumSubset(movimento, map),
    proc_comportamental: sumSubset(comportamental, map),

    fator_escolar_1:     sumSubset(fatorEscolar1, map),
    fator_escolar_2:     sumSubset(fatorEscolar2, map),
    fator_escolar_3:     sumSubset(fatorEscolar3, map),
    fator_escolar_4:     sumSubset(fatorEscolar4, map),
    total:               0
  };

  // soma geral de todos os itens respondidos
  let totalAll = 0;
  for(let i=1;i<=TOTAL_ITEMS;i++){
    totalAll += map["q"+String(i).padStart(2,"0")] ?? 0;
  }
  scores.total = totalAll;

  return scores;
}

/* monta CSV de categorias pra salvar na planilha */
function buildCategoriaCSV(scores){
  const entries = Object.entries(scores)
    .filter(([k])=>k!=="total")
    .map(([k,v])=>`${k}=${v}`);
  return entries.join(',');
}

/* ===== SUBMIT ===== */
let sending=false;
$("#form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  if(sending) return;
  sending = true;
  hideBox("#msg");

  const btn = $("#btnSubmit");
  const originalText = btn.textContent;
  btn.disabled = true;
  btn.textContent = "Enviando…";

  try{
    if(!patient) throw new Error("Sessão inválida. Recarregue o link.");

    // 1. garantir tudo respondido
    for(let i=1;i<=TOTAL_ITEMS;i++){
      const qn = String(i).padStart(2,'0');
      const sel = document.querySelector(`input[name="q${qn}"]:checked`);
      if(!sel){
        const row = document.querySelector(`.item[data-q="${i}"]`);
        if(row) row.scrollIntoView({behavior:'smooth', block:'center'});
        throw new Error(`Responda o item ${i}.`);
      }
    }

    // 2. anti-duplicidade
    const again = await sheetSearch(SHEETS.SCORES, { cpf: CPF, code: CODE });
    if(again && again.length){
      setBox("#msg","Este formulário já foi enviado anteriormente. Voltando ao portal…","ok");
      setTimeout(goPortalWithToken,1000);
      return;
    }

    // 3. coletar respostas
    const answersMap = {}; // { q01: 3, q02: 5, ... }
    const qaList = [];     // [{n, q, label, value}, ...]

    for(let i=1;i<=TOTAL_ITEMS;i++){
      const qn = String(i).padStart(2,"0");
      const sel = document.querySelector(`input[name="q${qn}"]:checked`);
      const val = Number(sel.value);

      const choiceInfo = RESPONSE_CHOICES.find(c => c.v === val) || {l:"",v:val};

      answersMap[`q${qn}`] = val;
      qaList.push({
        n: i,
        q: ITEMS[i-1]?.text || "",
        label: choiceInfo.l,
        value: val
      });
    }

    // 4. calcular escores
    const scores = computeScores(answersMap);
    const categoria_csv = buildCategoriaCSV(scores);
    const durationSec = Math.round((Date.now()-startAt)/1000);

    // 5. salvar na planilha
    await sheetCreate(SHEETS.SCORES, {
      result_id: `${patient.cpf}_${CODE}_${Date.now()}`,
      token: TOKEN,
      cpf: patient.cpf,
      code: CODE,
      source: "paciente",
      submitted_at: new Date().toISOString(),
      total: scores.total,
      categoria: categoria_csv,
      questions: JSON.stringify(qaList),
      metrics: JSON.stringify({
        answers: answersMap,
        results: scores,
        duration_sec: durationSec
      })
    });

    // 6. marcar como feito
    const doneUpdates = {};
    RELEASE_KEYS.map(k=>`${k}_FEITO`).forEach(k=>{
      if(k in patient) doneUpdates[k] = "sim";
    });
    if(Object.keys(doneUpdates).length===0){
      doneUpdates[`${RELEASE_KEYS[0]}_FEITO`] = "sim";
    }
    await sheetPatchBy(SHEETS.PATIENTS, "cpf", patient.cpf, doneUpdates);

    // 7. limpar e voltar
    clearDraft();
    setBox("#msg","Formulário enviado. Voltando ao portal…","ok");
    setTimeout(goPortalWithToken, 1100);

  }catch(err){
    console.error(err);
    setBox("#msg", err.message || "Falha ao enviar. Tente novamente.", "err");
    sending = false;
    btn.disabled = false;
    btn.textContent = originalText;
  }
});
</script>
</body>
</html>

